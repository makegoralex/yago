# Yago Repository Snapshot1



This workspace was set up to track the contents of the public repository at
<https://github.com/makegoralex/yago>. Network restrictions prevented fetching
updates directly from GitHub during this session, so the snapshot reflects the
state available locally.

## Инструкции по сборке и развёртыванию

Ниже — быстрый чек-лист на русском языке, который помогает повторно собрать и
запустить проект после деплоя на сервер.

### 1. Backend (Node.js + TypeScript)

1. Скопируйте `.env.example` в `.env` и укажите значения для `PORT`, `MONGODB_URI`
   и секретов JWT.
2. Установите зависимости и соберите проект:
   ```bash
   npm install
   npm run build
   ```
3. Запустите сервис. Для локального режима достаточно `npm run dev`. Для продакшн-
   окружения используйте `npm run start`. Если приложение крутится под PM2,
   перезапускайте его командой `pm2 restart <имя-процесса> --update-env` — имя
   процесса должно совпадать с тем, что вы указали при запуске (`pm2 start dist/index.js --name yago-api`).
4. После запуска API доступен по адресу `http://<host>:<PORT>`. Корневой маршрут `/`
   отдаёт лендинг с описанием возможностей POS. Для health-check используйте
   `http://<host>:<PORT>/healthz` — он возвращает JSON `{ "status": "ok" }`.

### 2. Frontend (PWA кассового интерфейса)

1. Перейдите в директорию `frontend/` и создайте `.env` на основе `.env.example`.
   Переменная `VITE_API_URL` не обязательна — по умолчанию PWA обращается к тому
   же домену, с которого загружено приложение.
2. Установите зависимости и соберите статику:
   ```bash
   npm install
   npm run build
   ```
3. Для локальной проверки можно запустить предпросмотр `npm run preview`. В бою
   размещайте содержимое `frontend/dist` за reverse-proxy или любым другим
   web-сервером (Nginx, Caddy и т. д.). Если вы деплоите backend и frontend на
   один сервер, достаточно скопировать папку `frontend/dist` рядом с Node.js
   проектом — Express автоматически найдёт бандл и начнёт отдавать статику и
   fallback-роут для SPA из этой директории. Если вы складываете файлы в другое
   место, пропишите абсолютный путь в переменной окружения
   `FRONTEND_DIST_PATH=/путь/к/готовому/dist` — сервер возьмёт оттуда `index.html`
   и ассеты.
4. После сборки интерфейс кассира доступен по `http://<host>:<порт>/pos`.
5. Для устройств на старых версиях Safari (например, iOS 10) добавлен
   «legacy»-бандл. После выполнения `npm install` и `npm run build` в каталоге
   `frontend/dist` появятся файлы `legacy-*.js` и `polyfills-legacy.js`. Их не
   нужно настраивать вручную — Express отдаёт их автоматически, но важно не
   удалять при выкладке, чтобы касса открывалась и на старых iPad.

### 3. Полезные напоминания

- Если меняете конфигурацию среды, не забывайте обновить переменные окружения и
  перезапустить сервис с флагом `--update-env`, чтобы PM2 подхватил изменения.
- Swagger-документация доступна на `/docs` и помогает быстро проверить схему API
  после обновления.
- Логи PM2 можно посмотреть командой `pm2 logs <имя-процесса>`.

### 4. Управление ассортиментом и складом

- После авторизации под администратором откройте `/admin` — вкладки **Меню**,
  **Ингредиенты**, **Поставщики** и **Склады** позволяют редактировать карточки
  сущностей по клику прямо из таблицы.
- Для оприходования поставки используйте форму «Приёмка» во вкладке **Склады**:
  выберите склад и поставщика, добавьте несколько позиций (ингредиенты или
  готовые продукты) с количеством и закупочной ценой — система сохранит одну
  накладную и автоматически пересчитает себестоимость.
- Себестоимость ингредиентов и товаров подтягивается в карточки каталога, а при
  продажах по `/pos` соответствующие остатки списываются со склада.

### 5. Быстрая пересборка API и PWA

- Чтобы гарантированно получить последние версии бэкенда (управление скидками,
  персоналом и отчёты по кассирам описаны в `src/routes/adminManagement.ts`) и
  кассового интерфейса (`frontend/src/pages/Admin.tsx`), выполните одну команду:

  ```bash
  npm run build:all
  ```

- Скрипт соберёт TypeScript API (`npm run build`) и тут же пересоберёт PWA
  (`npm --prefix frontend run build`), обновив `frontend/dist`. После этого
  Express автоматически начнёт отдавать свежий бандл, а новые функции станут
  доступны в `/admin` и `/pos` без дополнительных действий.

### 6. Модификаторы товаров

- Для работы с админкой авторизуйтесь под администратором (по умолчанию после
  деплоя доступен `admin@yago.coffee` с паролем `admin123`). Если при создании
  группы получаете ответ `Authorization token is required`, выйдите и выполните
  вход снова, чтобы обновить токены доступа.
-
- Создавать и редактировать группы модификаторов можно на вкладке **Меню** в
  `/admin` в карточке «Группы модификаторов». Укажите название, тип выбора
  (один или несколько вариантов), обязательность и список опций с изменением
  цены/себестоимости. Сохранённые группы отображаются списком справа; оттуда же
  их можно открыть на редактирование или удалить.
- Привязка к товарам выполняется в формах «Новая позиция» и «Настройка выбранной
  позиции» на той же вкладке: ниже блока цен появится список созданных групп с
  чекбоксами. Отметьте нужные — они сохранятся вместе с карточкой товара.
- В кассе `/pos` при добавлении позиции с модификаторами автоматически откроется
  модальное окно выбора. Для обязательных групп подтверждение блокируется, пока
  не выбран вариант. Итоговая цена пересчитывается по выбранным опциям, а в
  корзине под названием товара отображаются выбранные модификаторы.
