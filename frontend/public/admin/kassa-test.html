<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢–µ—Å—Ç –∫–∞—Å—Å—ã –ê–¢–û–õ 50–§</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 900px;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header .ip-address {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 50px;
      display: inline-block;
      font-family: monospace;
      font-size: 18px;
    }

    .content {
      padding: 40px;
    }

    .status-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .status-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #94a3b8;
    }

    .status-dot.connected {
      background: #10b981;
      animation: pulse 2s infinite;
    }

    .status-dot.error {
      background: #ef4444;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .test-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .test-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }

    .test-btn:active {
      transform: translateY(-2px);
    }

    .test-btn.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .test-btn.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .btn-icon {
      font-size: 24px;
    }

    .results {
      margin-top: 30px;
      background: #f1f5f9;
      border-radius: 12px;
      padding: 20px;
      display: none;
    }

    .results.active {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-item {
      padding: 10px 0;
      border-bottom: 1px solid #cbd5e1;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .hint {
      margin-top: 12px;
      color: #475569;
      line-height: 1.5;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Å—ã –ê–¢–û–õ 50–§</h1>
      <div class="ip-address" id="ipTag">192.168.0.139:5555</div>
      <p style="margin-top: 10px; opacity: 0.9">–ü–∞–Ω–µ–ª—å –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</p>
    </div>

    <div class="content">
      <div class="status-card">
        <div class="status-indicator">
          <div class="status-dot" id="statusDot"></div>
          <h3 id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è...</h3>
        </div>
        <div id="statusDetails">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–∞—Å—Å–µ...</div>
        <p class="hint">
          –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –∫–∞—Å—Å—É –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ VPN. –ü–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5555 (–∏–ª–∏ 16732 –¥–ª—è –¥—Ä–∞–π–≤–µ—Ä–∞), –ø—Ä–æ–≤–µ—Ä—å—Ç–µ,
          —á—Ç–æ –æ–Ω –æ—Ç–∫—Ä—ã—Ç.
        </p>
      </div>

      <div class="buttons-grid">
        <button class="test-btn" onclick="testConnection()">
          <span class="btn-icon">üîå</span>
          <span>–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
          <small>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å –∫–∞—Å—Å–æ–π</small>
        </button>

        <button class="test-btn success" onclick="printTestReceipt(100)">
          <span class="btn-icon">üßæ</span>
          <span>–ß–µ–∫ 100‚ÇΩ</span>
          <small>–¢–µ—Å—Ç–æ–≤–∞—è –ø–µ—á–∞—Ç—å</small>
        </button>

        <button class="test-btn success" onclick="printTestReceipt(500)">
          <span class="btn-icon">üí∞</span>
          <span>–ß–µ–∫ 500‚ÇΩ</span>
          <small>–ü–µ—á–∞—Ç—å –Ω–∞ 500‚ÇΩ</small>
        </button>

        <button class="test-btn danger" onclick="printTestReceipt(1)">
          <span class="btn-icon">‚ö†Ô∏è</span>
          <span>–ß–µ–∫ 1‚ÇΩ</span>
          <small>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç</small>
        </button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ –∫–∞—Å—Å–µ...</p>
      </div>

      <div class="results" id="results">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:</h3>
        <div id="resultsContent"></div>
      </div>
    </div>
  </div>

  <script>
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const statusDetails = document.getElementById('statusDetails');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');
    const ipTag = document.getElementById('ipTag');

    const DEFAULT_IP = '192.168.0.139';
    const DEFAULT_PORT = '5555';

    window.onload = checkStatus;

    async function checkStatus() {
      try {
        const response = await fetch('/api/kassa-test/status');
        const data = await response.json();

        ipTag.textContent = `${data.ip ?? DEFAULT_IP}:${data.port ?? DEFAULT_PORT}`;

        if (data.success) {
          statusDot.className = 'status-dot connected';
          statusText.textContent = '–ö–∞—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞';
          statusDetails.innerHTML = `
            <p><strong>IP:</strong> ${data.ip}</p>
            <p><strong>–ü–æ—Ä—Ç:</strong> ${data.port}</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.status}</p>
            <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
          `;
        } else {
          statusDot.className = 'status-dot error';
          statusText.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
          statusDetails.innerHTML = `
            <p><strong>–û—à–∏–±–∫–∞:</strong> ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
            <p><strong>IP:</strong> ${data.ip ?? DEFAULT_IP}</p>
            <p><strong>–ü–æ—Ä—Ç:</strong> ${data.port ?? DEFAULT_PORT}</p>
            <p style="color: #ef4444">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∫–∞—Å—Å–∞, –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∫ —Å–µ—Ç–∏</p>
          `;
        }
      } catch (error) {
        statusDot.className = 'status-dot error';
        statusText.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
        statusDetails.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + error.message;
      }
    }

    async function testConnection() {
      showLoading();

      try {
        const response = await fetch('/api/kassa-test/test-connection');
        const data = await response.json();

        showResults('–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', data);
        if (data.success) {
          checkStatus();
        }
      } catch (error) {
        showResults('–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', {
          success: false,
          error: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error.message,
        });
      }
    }

    async function printTestReceipt(amount) {
      showLoading();

      try {
        const response = await fetch('/api/kassa-test/print-test', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            amount: amount,
            paymentType: 1,
          }),
        });

        const data = await response.json();
        showResults(`–ü–µ—á–∞—Ç—å —á–µ–∫–∞ –Ω–∞ ${amount}‚ÇΩ`, data);
      } catch (error) {
        showResults('–ü–µ—á–∞—Ç—å —á–µ–∫–∞', {
          success: false,
          error: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error.message,
        });
      }
    }

    function showLoading() {
      loading.classList.add('active');
      results.classList.remove('active');
    }

    function showResults(title, data) {
      loading.classList.remove('active');
      results.classList.add('active');

      let html = `
        <div class="result-item">
          <strong>–¢–µ—Å—Ç:</strong> ${title}
        </div>
        <div class="result-item">
          <strong>–°—Ç–∞—Ç—É—Å:</strong>
          <span style="color: ${data.success ? '#10b981' : '#ef4444'};">
            ${data.success ? '‚úÖ –£–°–ü–ï–•' : '‚ùå –û–®–ò–ë–ö–ê'}
          </span>
        </div>
      `;

      if (data.message) {
        html += `
          <div class="result-item">
            <strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${data.message}
          </div>
        `;
      }

      if (data.error) {
        html += `
          <div class="result-item">
            <strong>–û—à–∏–±–∫–∞:</strong>
            <span style="color: #ef4444;">${data.error}</span>
          </div>
        `;
      }

      if (data.data) {
        html += `
          <div class="result-item">
            <strong>–î–∞–Ω–Ω—ã–µ –æ—Ç –∫–∞—Å—Å—ã:</strong>
            <pre style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px; overflow: auto;">${JSON.stringify(
              data.data,
              null,
              2
            )}</pre>
          </div>
        `;
      }

      if (data.config) {
        html += `
          <div class="result-item">
            <strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong>
            <pre style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
IP: ${data.config.ip}
–ü–æ—Ä—Ç: ${data.config.port}
–°—Ç–∞—Ç—É—Å: ${data.config.status}
            </pre>
          </div>
        `;
      }

      resultsContent.innerHTML = html;
    }
  </script>
</body>
</html>
