# Windows-агент для касс АТОЛ: контракт и серверная связка

Документ описывает, как связать облачный бэкенд с локальной кассой АТОЛ через лёгкий Windows-агент. Серверная очередь и контракт объединены в один поток задач — дополнительных микросервисов не требуется.

## Картина целиком
- **Бэкенд**: хранит настройки кассы (IP/порт, ИНН/ФИО кассира), ставит задачи в очередь и выдаёт их агенту, принимает статусы и коды ФН.
- **Windows-агент**: простое exe (один файл) с полями «URL сервера», «Токен агента», «IP кассы» и кнопкой «Проверить соединение». Подключается по HTTPS/WebSocket или периодическому long-poll, выполняет команды через `libfptr_*`, возвращает статусы/ошибки.
- **Поток задач**: операции `open_shift`, `close_shift`, `sale`, `refund`. Для продаж и возвратов поддерживаем типы оплат `cash` и `card`.

## Серверные маршруты (объединённый поток)
- `POST /fiscal-tasks` — создать задачу. Тело: объект `task` по схеме ниже.
- `GET /fiscal-tasks/next` (long-poll, или WS-сообщение `task:next`) — агент запрашивает следующую невыполненную задачу для своей организации/устройства.
- `POST /fiscal-tasks/:id/status` — агент присылает промежуточные/финальные статусы.

**Примечания**
- Авторизация: заголовок `Authorization: Bearer <agentToken>` на всех маршрутах.
- Фильтрация задач: привязка к `organizationId` и конкретному устройству (`fiscalDeviceId`), чтобы разные кассы не забирали чужие задания.
- Хранение: задачи сохраняем в MongoDB рядом с `fiscalDevices`, добавляем индексы по `organizationId`, `fiscalDeviceId`, `status`.

## Схема задачи (сервер → агент)
```json
{
  "taskId": "uuid",
  "type": "open_shift | close_shift | sale | refund",
  "fiscalDeviceId": "...",
  "kkt": {
    "ip": "192.168.0.10",
    "port": 4510
  },
  "operator": {
    "name": "Кассир Иванов И.",
    "vatin": "123456789047"
  },
  "receipt": {
    "items": [
      {
        "name": "Товар",
        "price": 500,
        "quantity": 1,
        "vat": { "type": "none" }
      }
    ],
    "payments": [
      { "type": "cash", "sum": 500 }
    ],
    "total": 500,
    "taxationSystem": "osn",  
    "receiptType": "sell | sell_return"  
  }
}
```

### Минимально обязательные поля
- `taskId`, `type`, `fiscalDeviceId`.
- Для `open_shift`/`close_shift`: только `operator` (ФИО + ИНН).
- Для `sale`/`refund`: `items[]`, `payments[]`, `total`, `receiptType` (`sell` для продажи, `sell_return` для возврата), `taxationSystem` (значения из `FISCAL_TAX_SYSTEMS`).
- Поле `kkt` нужно, чтобы агент знал адрес кассы, даже если бэкенд работает в другой сети.

## Ответ агента (агент → сервер)
```json
{
  "taskId": "uuid",
  "status": "queued | in_progress | done | error",
  "error": "Сообщение об ошибке" ,
  "fiscal": {
    "fnCode": "1234567890123456",
    "receiptId": "...", 
    "shiftAutoOpened": false
  }
}
```
- `status` меняется по мере выполнения: сразу после получения можно отправить `in_progress`, затем `done` или `error`.
- `fnCode` (ФН/фискальный признак) возвращаем по требованию заказчика; касса при этом печатает бумажный чек.

## Поток работы агента
1. При старте агент подтягивает конфиг (server URL, token, IP/порт кассы) и проверяет соединение с кассой кнопкой «Проверить соединение» (ping драйвера/`/requests`).
2. Открывает WebSocket или начинает long-poll на `/fiscal-tasks/next` с токеном.
3. Получив задачу, отправляет `in_progress`, выполняет `libfptr_*` (см. официальные примеры), после `checkDocumentClosed()` возвращает `done` + `fnCode`.
4. При сетевых проблемах с кассой отвечает `error` с пояснением; бэкенд может повторно выдать задачу.

## Что осталось уточнить
- Протокол доставки: по умолчанию long-poll каждые 3–5 секунд; можно переключить на WebSocket, если в сети клиентов нет ограничений.
- Формат токена: достаточно статического JWT для первой версии; позже — ротация и привязка к устройству.
- Логи: агент пишет локальный log-файл с последними N событиями и отображает ошибки в UI.
